# Конвертор данных из PostgreSQL в PostgreSQL

Модуль для конвертации данных из одной базы данных PostgreSQL в другую с использованием Python и psycopg2.

## Установка

1. Установите зависимости:
```
pip install -r requirements.txt
```

2. Создайте файл `.env` на основе `.env.example`:
```
cp .env.example .env
```
В Windows можно скопировать файл вручную или использовать команду:
```
copy .env.example .env
```

3. Отредактируйте файл `.env`, указав правильные учетные данные для исходной и целевой баз данных PostgreSQL.

## Структура проекта

### Основные модули

- `main.py` - Главный файл для запуска программы конвертации
- `db_connection.py` - Модуль для подключения к исходной и целевой базам данных
- `convertor.py` - Основной модуль конвертации данных
- `dictionaries.py` - Модуль для создания и обновления словарей данных
- `insert_data.py` - Модуль для вставки данных в целевую базу данных
- `table_definitions.py` - Модуль с определениями структур таблиц
- `create_tables.py` - Модуль для создания таблиц в целевой базе данных
- `drop_tables.py` - Модуль для удаления таблиц из целевой базы данных
- `utils.py` - Вспомогательные функции для отображения данных

### Вспомогательные скрипты

- `test_connection.py` - Модуль для тестирования соединения с базой данных
- `create_target_db.py` - Скрипт для автоматического создания целевой базы данных
- `create_dump.py` - Скрипт для создания дампов базы данных (только данные, INSERT format)
- `list_all_go.py` - Скрипт для вывода всех городских округов Приморского края
- `find_city_code.py` - Скрипт для поиска кода городского округа по названию

### Конфигурационные файлы

- `.env` - Файл с учетными данными для подключения к базам данных
- `.env.example` - Пример файла с учетными данными
- `requirements.txt` - Файл с зависимостями проекта

## Использование

### Запуск программы конвертации

Для запуска основной программы выполните:
```
python main.py
```

Программа выполнит следующие действия:
1. Проверит соединение с базами данных
2. Удалит существующие таблицы в целевой базе данных
3. Создаст таблицы согласно определениям в `table_definitions.py`
4. Создаст основные словари данных из исходной базы данных (населенные пункты, улицы, здания)
5. Создаст дополнительные словари данных (типы домов, типы дополнительных номеров)
6. Обновит словари данных дополнительной информацией
7. Вставит данные в таблицы целевой базы данных

### Тестирование подключения

Для тестирования только подключения к базе данных запустите:
```
python db_connection.py
```

### Создание целевой базы данных

Для автоматического создания целевой базы данных:
```
python create_target_db.py
```

Скрипт проверит существование базы данных и создаст её, если она не существует.

### Создание дампа базы данных

Для создания дампа целевой базы данных (только данные в формате INSERT):
```
python create_dump.py
```

Дамп будет сохранен в файл формата: `psql_gar_simple_db_dump_{suffix}.sql`
- Для `gar_simple_db_arsenev` → `psql_gar_simple_db_dump_arsenev.sql`
- Для `gar_simple_db_spassk` → `psql_gar_simple_db_dump_spassk.sql`

**Опционально**: Для сохранения дампов в отдельную директорию добавьте в `.env`:
```env
DUMP_DIR=d:\tmp
```

### Поиск кодов городских округов

#### Вывод всех городских округов Приморского края:
```
python list_all_go.py
```

#### Поиск конкретного городского округа по названию:
```
python find_city_code.py Арсеньев
```

Скрипт найдет городской округ и выведет его `BASE_PATH` для использования в `.env`

### Структура таблиц

В проекте используются следующие таблицы:

1. `localities` - Таблица населенных пунктов:
   - id - Уникальный идентификатор записи
   - objectid - Идентификатор объекта из исходной базы данных
   - name - Название населенного пункта
   - type - Тип населенного пункта

2. `streets` - Таблица улиц:
   - id - Уникальный идентификатор записи
   - locality_id - Идентификатор населенного пункта
   - objectid - Идентификатор объекта из исходной базы данных
   - name - Название улицы
   - type - Тип улицы

3. `buildings` - Таблица зданий:
   - id - Уникальный идентификатор записи
   - street_id - Идентификатор улицы
   - objectid - Идентификатор объекта из исходной базы данных
   - number - Номер дома
   - add_num1 - Дополнительный номер 1
   - add_num2 - Дополнительный номер 2
   - type - Тип дома
   - add_type1 - Тип дополнительного номера 1
   - add_type2 - Тип дополнительного номера 2

## Словари данных

Проект использует следующие словари данных:

1. Основные словари:
   - `dictionary_locality` - Словарь населенных пунктов
   - `dictionary_street` - Словарь улиц
   - `dictionary_building` - Словарь зданий

2. Дополнительные словари:
   - `dictionary_house_types` - Словарь типов домов
   - `dictionary_add_house_types` - Словарь типов дополнительных номеров

Эти словари формируются из данных исходной базы данных и используются для заполнения таблиц в целевой базе данных.

## Расширение проекта

Для добавления новой таблицы в базу данных:

1. Добавьте определение таблицы в `table_definitions.py`:
```python
TABLE_DEFINITIONS['new_table'] = """
    CREATE TABLE new_table (
        id SERIAL PRIMARY KEY,
        field1 VARCHAR(100) NOT NULL,
        field2 INTEGER
    );
"""
```

2. Добавьте имя таблицы в список `ALL_TABLES` в правильном порядке создания:
```python
ALL_TABLES = ['localities', 'streets', 'buildings', 'new_table']
```

3. Создайте функцию для создания и обновления словаря данных в `dictionaries.py`:
```python
def update_new_table_dictionary(source_cursor, dictionary_new_table):
    # Ваш код для обновления словаря
    return dictionary_new_table
```

4. Создайте функцию для вставки данных в `insert_data.py`:
```python
def insert_new_table_data(target_cursor, dictionary_new_table):
    # Ваш код для вставки данных
    return True
```

5. Обновите функцию `convertor()` в `convertor.py`, добавив вызовы новых функций.

После этого таблица будет автоматически создаваться и заполняться данными вместе с остальными таблицами.

## Настройка параметров

В файле `.env` можно настроить следующие параметры:

- `SOURCE_DB_HOST` - Хост исходной базы данных
- `SOURCE_DB_PORT` - Порт исходной базы данных
- `SOURCE_DB_NAME` - Имя исходной базы данных
- `SOURCE_DB_USER` - Пользователь исходной базы данных
- `SOURCE_DB_PASSWORD` - Пароль исходной базы данных

- `TARGET_DB_HOST` - Хост целевой базы данных
- `TARGET_DB_PORT` - Порт целевой базы данных
- `TARGET_DB_NAME` - Имя целевой базы данных
- `TARGET_DB_USER` - Пользователь целевой базы данных
- `TARGET_DB_PASSWORD` - Пароль целевой базы данных

- `BASE_PATH` - Базовый путь для фильтрации данных в исходной базе данных (формат: `381755.XXXXXXXX`)
- `DUMP_DIR` - (Опционально) Директория для сохранения дампов базы данных

## Примеры BASE_PATH для разных регионов

### Приморский край (381755)

| Городской округ | BASE_PATH | TARGET_DB_NAME |
|----------------|-----------|----------------|
| г.о. Спасск-Дальний | 381755.95238066 | gar_simple_db_spassk |
| г.о. Арсеньевский | 381755.95238154 | gar_simple_db_arsenev |
| г.о. Артемовский | 381755.95238215 | gar_simple_db_artem |
| г.о. Владивостокский | 381755.95238214 | gar_simple_db_vl |
| г.о. Находкинский | 381755.95238220 | gar_simple_db_nakhodka |
| г.о. Уссурийский | 381755.95238222 | gar_simple_db_ussuriysk |

Полный список городских округов можно получить командой:
```bash
python list_all_go.py
```

## Работа с несколькими регионами

### Пример 1: Конвертация для Арсеньевского округа

1. Обновите `.env`:
```env
TARGET_DB_NAME=gar_simple_db_arsenev
BASE_PATH=381755.95238154
```

2. Создайте базу данных:
```bash
python create_target_db.py
```

3. Запустите конвертацию:
```bash
python main.py
```

4. Создайте дамп:
```bash
python create_dump.py
```

### Пример 2: Конвертация для другого региона

1. Найдите код региона:
```bash
python find_city_code.py "Название города"
```

2. Скопируйте найденный `BASE_PATH` в `.env`

3. Повторите шаги 2-4 из Примера 1

## Особенности работы в Windows

### Кодировка консоли

Для корректного отображения русских букв в терминале Windows выполните перед запуском скриптов:
```bash
chcp 65001
```

Это переключит кодовую страницу консоли на UTF-8.

### Автоматическая установка кодировки

Добавьте в ваш PowerShell профиль:
```powershell
chcp 65001 > $null
```

## Формат дампов

Созданные дампы содержат:
- ✅ Только данные (без CREATE TABLE)
- ✅ INSERT statements вместо COPY
- ✅ Кодировка UTF-8
- ✅ Формат имени: `psql_gar_simple_db_dump_{suffix}.sql`

Пример содержимого:
```sql
INSERT INTO public.buildings VALUES (48254193, 379797, '4', '', '', 'д.', NULL, NULL);
INSERT INTO public.streets VALUES (1, 95238066, 379797, 'Ленина', 'ул.');
INSERT INTO public.localities VALUES (1, 95238066, 'Арсеньев', 'г.');
```

## Статистика конвертации

### Спасск-Дальний (BASE_PATH: 381755.95238066)
- Населенные пункты: 1
- Улицы: 169
- Здания: 6,004
- Размер дампа: ~0.2 МБ

### Арсеньевский (BASE_PATH: 381755.95238154)
- Населенные пункты: 1
- Улицы: 229
- Здания: 6,125
- Размер дампа: ~0.54 МБ 